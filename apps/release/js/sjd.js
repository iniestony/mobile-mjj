var mobileSJD=angular.module("sjdApp",["ui.router","ui.bootstrap","ui.select"]);mobileSJD.config(["$urlRouterProvider",function($urlRouterProvider){$urlRouterProvider.when("/","/welcome"),$urlRouterProvider.when("","/welcome"),$urlRouterProvider.otherwise("/welcome")}]).constant("xhrRequestOrigin","http://test.sjdbank.com:8787/").constant("base","/apps"),mobileSJD.config(["$stateProvider","base",function($stateProvider,base){$stateProvider.state("dashboard",{url:"/dashboard",templateUrl:base+"/pages/dashboard/dashboard.html",controller:"dashboardCtrl"})}]).controller("dashboardCtrl",["$scope","$rootScope","$state","$stateParams","$uibModal","xhrRequestOrigin","$http","Constants",function($scope,$rootScope,$state,$stateParams,$uibModal,xhrRequestOrigin,$http,Constants){void 0!=$rootScope.enterpriseid&&void 0!=$rootScope.user||$state.go("login"),$scope.status=0,$scope.message="当前没有进行中的贷款申请,您可以提交一份贷款意向进行申请.";var currentproject_url=xhrRequestOrigin+"/customerproject/isactive.do?enterpriseid="+$rootScope.enterpriseid;$http.get(currentproject_url,{},{}).success(function(response){$rootScope.project={},$rootScope.project.id=response.idcustomerproject,$rootScope.project.status=response.status,$rootScope.project.loanid=response.loanid,$scope.status=response.status,$scope.message=messageCollection[$scope.status],$rootScope.project.intention={},void 0!=response.othersObject&&void 0!=response.othersObject.amount&&($rootScope.project.intention.amount=response.othersObject.amount,$rootScope.project.intention.duration=response.othersObject.duration,$rootScope.project.intention.usage=response.othersObject.usereason),callbackCollection[$scope.status]()});var messageCollection={1:"请填写初步调查问卷并提交",2:"您的基本情况已提交，请等待工作人员的核实",18:"您的贷款申请已提交,请耐心等待审核",12:"您的贷款申请已提交,请耐心等待审核",19:"您的贷款申请已提交,请耐心等待审核",16:"您的贷款申请已提交,请耐心等待审核",181:"很抱歉，我们暂时无法为您提供服务",20:"恭喜您！您的贷款意向已通过数据贷评估，请发起正式申请",21:"您正在进行贷款申请，请填写完整的申请表并提交",22:"您的贷款资料审核不通过，请补充、修改贷款资料",262:"非常抱歉, 您的贷款申请被拒绝",8:"非常抱歉, 您的贷款申请被拒绝",23:"您的贷款申请已提交资金方审批，请耐心等候",260:"您的贷款申请已提交资金方审批，请耐心等候",26:"您的贷款申请已提交资金方审批，请耐心等候",27:"恭喜您！您的贷款已通过资金方审批",5:"",35:"",79:""},callbackCollection={1:function(){},2:function(){},18:function(){},12:function(){},19:function(){},16:function(){},181:function(){},20:function(){},21:function(){},22:function(){},262:function(){},8:function(){},23:function(){},260:function(){},26:function(){},27:function(){},5:function(){$http.get(xhrRequestOrigin+"/api//loanstatement/data.do?action=loan&loanid="+$rootScope.project.loanid).success(function(data){$scope.usedamount=data.value.usedamount,$scope.ratio=data.value.ratio,$scope.amount=parseFloat((data.value.amount/1e4).toFixed(2));var d=new Date(data.value.expireddate);$scope.expireddate=d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate(),$scope.minimum=parseFloat((parseFloat($scope.usedamount)/parseFloat($scope.ratio)).toFixed(0)),$http.get(xhrRequestOrigin+"/bankvisit//loan/stockValue.do?loanid="+$rootScope.project.loanid).success(function(data1){$scope.core=parseFloat(data1.totalvalue.toFixed(0)),$scope.out=$scope.core-$scope.minimum})})},35:function(){},79:function(){}};$scope.navigate=function(state){"goodsout"===state&&(Constants.estimateTotal=$scope.out),$state.go(state)}}]).service("Constants",[function(){this.estimateTotal=0}]),mobileSJD.config(["$stateProvider","base",function($stateProvider,base){$stateProvider.state("application",{url:"/application",templateUrl:base+"/pages/application/application.html",controller:"applicationCtrl"})}]).controller("applicationCtrl",["$scope","$rootScope","$state","$uibModal","$http","xhrRequestOrigin","base",function($scope,$rootScope,$state,$uibModal,$http,xhrRequestOrigin,base){$scope.personItems=[{key:"fullname",value:"",name:"姓名",show:!1,options:[]},{key:"gender",value:"",name:"性别",show:!1,options:[]},{key:"uid",value:"",name:"身份证",show:!1,options:[]},{key:"mobile",value:"",name:"手机号",show:!1,options:[]},{key:"graduate",value:"",name:"毕业院校",show:!1,options:[]},{key:"liveaddress",value:"",name:"现居住地址",show:!1,options:[]},{key:"huji",value:"",name:"户籍",show:!1,options:[]},{key:"houseproperty",value:"",name:"现居房产属性",show:!1,options:[]},{key:"carnum",value:"",name:"车辆数量",show:!1,options:[]},{key:"housenum",value:"",name:"房产数量",show:!1,options:[]},{key:"marriage",value:"",name:"婚姻状况",show:!1,options:[]},{key:"spousename",value:"",name:"配偶姓名",show:!1,options:[]},{key:"housevalue",value:"",name:"房产净值",show:!1,options:[]},{key:"spouseid",value:"",name:"配偶身份证号",show:!1,options:[]},{key:"spousework",value:"",name:"配偶从事工作",show:!1,options:[]},{key:"familynum",value:"",name:"家庭总人口",show:!1,options:[]},{key:"percourt",value:"",name:"法院执行情况",show:!1,options:[]},{key:"ispsninsurance",value:"",name:"有无人财保险",show:!1,options:[]},{key:"workinityears",value:"",name:"从事该行业年限",show:!1,options:[]},{key:"shareproportion",value:"",name:"企业占股比例",show:!1,options:[]}],$scope.enterpriseItems=[{key:"enterprisename",value:"",name:"公司全称",show:!1,options:[]},{key:"yearlysales",value:"",name:"年化销售额",show:!1,options:[]},{key:"registeredcapital",value:"",name:"注册资本",show:!1,options:[]},{key:"scope",value:"",name:"经营范围",show:!1,options:[]},{key:"legalrepresentative",value:"",name:"法人",show:!1,options:[]},{key:"operator",value:"",name:"实际经营者",show:!1,options:[]},{key:"acturaladdress",value:"",name:"实际经营地址",show:!1,options:[]},{key:"industry",value:"",name:"经济行业",show:!1,options:[]},{key:"address",value:"",name:"企业地址",show:!1,options:[]},{key:"registereddate",value:"",name:"工商注册时间",show:!1,options:[]},{key:"salestype",value:"",name:"销售类型",show:!1,options:[]},{key:"enterprisetype",value:"",name:"企业类型",show:!1,options:[]},{key:"onlinestores",value:"",name:"网上商店",show:!1,options:[]},{key:"physicalstores",value:"",name:"实体店",show:!1,options:[]},{key:"hallstores",value:"",name:"商场专柜",show:!1,options:[]},{key:"salesvolume",value:"",name:"销售规模",show:!1,options:[]},{key:"factoryproperty",value:"",name:"生产场地性质",show:!1,options:[]},{key:"salesarea",value:"",name:"主要销售地区",show:!1,options:[]},{key:"employeenum",value:"",name:"员工人数",show:!1,options:[]},{key:"orgnizationtype",value:"",name:"组织形式",show:!1,options:[]},{key:"top10operatingrate",value:"",name:"十大客户营业率",show:!1,options:[]},{key:"ledgeperiod",value:"",name:"应收款账期",show:!1,options:[]},{key:"insurance",value:"",name:"是否购买保险",show:!1,options:[]}],$scope.loanItems=[{key:"personelloan",value:"",name:"个人银行融资",show:!1,options:[]},{key:"personelguarangee",value:"",name:"个人对外担保",show:!1,options:[]},{key:"bankloanamount",value:"",name:"银行融资金额",show:!1,options:[]},{key:"guaranteednum",value:"",name:"对外担保家数",show:!1,options:[]},{key:"guranteedamount",value:"",name:"对外担保金额",show:!1,options:[]},{key:"nonbankloanamount",value:"",name:"非银行融资",show:!1,options:[]},{key:"defaultpayments",value:"",name:"违约还款",show:!1,options:[]}],$scope.extraItems=[{key:"paymentSource",value:"",name:"还款来源",show:!1,options:[]}];var preservedBean={},beanKeys=["personalinfo","enterpriseinfo","loaninfo","extrainfo"],scopeKeys=["personItems","enterpriseItems","loanItems","extraItems"];$scope.showTitle=function(array){for(var show=!1,i=0;i<array.length;i++)if(array[i].show){show=!0;break}return show},$scope.parsePerson=function(item){"marriage"===item.key&&($scope.personItems[11].show=$scope.personItems[11].preservedShow&&"已婚"===item.value,$scope.personItems[13].show=$scope.personItems[13].preservedShow&&"已婚"===item.value,$scope.personItems[14].show=$scope.personItems[14].preservedShow&&"已婚"===item.value)};var getPictures=function(){$scope.pictures={},$scope.keys=[],$http.get(xhrRequestOrigin+"/loanapplicationdoc/app/loandocs/show.do?customerprojectid="+$rootScope.project.id).success(function(data){$scope.keys=Object.keys(data),$scope.keys.forEach(function(k){$scope.pictures[k+"Src"]={name:data[k].name,images:[],id:k,pass:data[k].isPass};for(var i in data[k].files)$scope.pictures[k+"Src"].images.push({name:data[k].name,uri:xhrRequestOrigin+"/"+data[k].files[i],url:data[k].files[i],filename:i})})})};$http.get(xhrRequestOrigin+"/loanapplication/app/form/getform.do?customerprojectid="+$rootScope.project.id).success(function(data){preservedBean=angular.copy(data.bean);for(var i=0;i<beanKeys.length;i++)data.bean[beanKeys[i]]&&"object"==typeof data.bean[beanKeys[i]]&&($scope[scopeKeys[i]].forEach(function(item){if(item.show=data.bean[beanKeys[i]].hasOwnProperty(item.key),item.preservedShow=data.bean[beanKeys[i]].hasOwnProperty(item.key),item.value=data.bean[beanKeys[i]][item.key],data.selections&&"object"==typeof data.selections&&data.selections.hasOwnProperty(item.key)&&Object.keys(data.selections[item.key]).length>0){item.options=[];for(var k in data.selections[item.key])item.options.push({name:k,value:data.selections[item.key][k]});item.value||(item.value=item.options[0].value)}else item.options=[]}),"personItems"===scopeKeys[i]&&($scope.personItems[11].show=$scope.personItems[11].preservedShow&&"已婚"===$scope.personItems[10].value,$scope.personItems[13].show=$scope.personItems[13].preservedShow&&"已婚"===$scope.personItems[10].value,$scope.personItems[14].show=$scope.personItems[14].preservedShow&&"已婚"===$scope.personItems[10].value))}),$scope.pictures={},$scope.keys=[],getPictures(),$scope.upload=function(item){$uibModal.open({templateUrl:base+"/pages/application/upload.html",controller:"uploadCtrl",windowClass:"sjd-page-application-upload-window",backdrop:"static",keyboard:!1,resolve:{item:function(){return $scope.pictures[item+"Src"]},images:function(){return angular.copy($scope.pictures[item+"Src"].images)}}}).result.then(function(dataURIs){$scope.pictures[item+"Src"].images=dataURIs},function(){})},void 0!=$rootScope.project.intention?($scope.amount=$rootScope.project.intention.amount/1e4,$scope.duration=$rootScope.project.intention.duration,$scope.usage=$rootScope.project.intention.usage):$scope.amount=0,$scope.step1to2=function(){var url=xhrRequestOrigin+"/loanapplication/loan/createloan.do?";$http({method:"post",url:url,params:{customerprojectid:$rootScope.project.id,enterpriseid:$rootScope.enterpriseid,amount:1e4*$scope.amount,duration:$scope.duration,usage:$scope.usage},transformResponse:function(d){return d}}).success(function(resp){$rootScope.project.intention.amount=1e4*$scope.amount,$rootScope.project.intention.duration=$scope.duration,$rootScope.project.intention.usage=$scope.usage}),$scope.step=2},$scope.toStep2=function(){$scope.step=2},$scope.toStep1=function(){saveForm(),$scope.step=1},$scope.toStep3=function(){saveForm(),$scope.step=3,getPictures()};var saveForm=function(){for(var i=0;i<beanKeys.length;i++)preservedBean[beanKeys[i]]&&"object"==typeof preservedBean[beanKeys[i]]&&$scope[scopeKeys[i]].forEach(function(item){preservedBean[beanKeys[i]][item.key]=item.value});$http({method:"POST",url:xhrRequestOrigin+"/loanapplication/loanmobile/saveform.do?customerprojectid="+$rootScope.project.id,data:preservedBean})};$scope.submit=function(){var commitUrl=xhrRequestOrigin+"loanapplication/form/commit.do?customerprojectid="+$rootScope.project.id;$http({method:"post",url:commitUrl,transformResponse:function(d){return d}}).success(function(){$state.go("dashboard")}).error(function(msg2){})}}]).controller("uploadCtrl",["$scope","$rootScope","$uibModalInstance","$http","xhrRequestOrigin","item","images","imageReader",function($scope,$rootScope,$uibModalInstance,$http,xhrRequestOrigin,item,images,imageReader){$scope.title="上传资料:"+item.name,$scope.images=images,$scope.docid=item.id,$scope.removeImage=function(image){var url=($rootScope.enterpriseid,xhrRequestOrigin+"/loanapplicationdoc/applydoc/delete.do?enterpriseid="+$rootScope.enterpriseid),deleteimage={};deleteimage.files={},deleteimage.imagetype=image.name,deleteimage.files[image.filename]=image.url,$http({method:"POST",url:url,params:deleteimage,transformResponse:function(d){return d}}).success(function(response){$scope.images=$scope.images.reduce(function(prev,next){return image.filename!==next.filename&&prev.push(next),prev},[])})},$scope.uploadImage=function(){document.getElementById("image-commit").click()},$scope.getImage=function(){imageReader.readImage($scope.imageFile,this).then(function(result){console.log($scope.imageFile),$scope.images.push({name:$scope.imageFile.name,uri:result})})},$scope.submit=function(){$uibModalInstance.close($scope.images)},$scope.cancel=function(){$uibModalInstance.dismiss()}}]).directive("customOnChange",["$http","$rootScope","xhrRequestOrigin",function($http,$rootScope,xhrRequestOrigin){return{restrict:"A",link:function(scope,element,attrs){element.bind("change",function(e){scope.imageFile=(event.srcElement||event.target).files[0],scope.getImage(),console.log(scope.imageFile);var fd=new FormData;fd.append("files",scope.imageFile),$http.post(xhrRequestOrigin+"/loanapplicationdoc//app/applydoc/upload.do?customerprojectid="+$rootScope.project.id+"&idchecklist="+scope.docid,fd,{transformRequest:angular.identity,headers:{"Content-Type":void 0},transformResponse:function(d){return d}}).success(function(res){}).error(function(status,err){alert("上传失败")})})}}}]).factory("imageReader",["$q",function($q){var onLoad=function(reader,deferred,scope){return function(){scope.$apply(function(){deferred.resolve(reader.result)})}},onError=function(reader,deferred,scope){return function(){scope.$apply(function(){deferred.reject(reader.result)})}},getReader=function(deferred,scope){var reader=new FileReader;return reader.onload=onLoad(reader,deferred,scope),reader.onerror=onError(reader,deferred,scope),reader},readImage=function(file,scope){var deferred=$q.defer(),reader=getReader(deferred,scope);return reader.readAsDataURL(file),deferred.promise};return{readImage:readImage}}]),mobileSJD.config(["$stateProvider","base",function($stateProvider,base){$stateProvider.state("goodsin",{url:"/goodsin",templateUrl:base+"/pages/goodsin/goodsin.html",controller:"goodsinCtrl"})}]).controller("goodsinCtrl",["$scope","$rootScope","$state","$uibModal","$http","xhrRequestOrigin","base","sjdDialog",function($scope,$rootScope,$state,$uibModal,$http,xhrRequestOrigin,base,sjdDialog){$scope.products=[],$scope.stockname="",$scope.contact="",$scope.phone="",$scope.memo="",$scope.submit=function(){for(var requestData={header:{contact:$scope.contact,phone:$scope.phone,stockname:$scope.stockname,memo:$scope.memo,creator:$rootScope.user.name},details:[]},i=0;i<$scope.products.length;i++)requestData.details.push({erpid:$scope.products[i].erpid,name:$scope.products[i].name,count:$scope.products[i].count});var url=xhrRequestOrigin+"/stockpost/sjd/entryPush.do?enterpriseid="+$rootScope.enterpriseid;url=url+"&data="+JSON.stringify(requestData),$http.post(url).success(function(){$state.go("dashboard")}).error(function(msg){sjdDialog.open("Error",msg)})},$scope.addGoods=function(){$uibModal.open({templateUrl:base+"/pages/goodsin/add.html",controller:"goodsinAddCtrl",windowClass:"sjd-page-goodsin-add-window",backdrop:"static",keyboard:!1}).result.then(function(data){for(var existingIDs=$scope.products.map(function(p){return p.erpid}),i=0;i<data.length;i++)existingIDs.indexOf(data[i].erpid)<0&&$scope.products.push({erpid:data[i].erpid,name:data[i].name,count:0})},function(){})},$scope.deleteProduct=function(index){$scope.products.splice(index,1)}}]).controller("goodsinAddCtrl",["$scope","$rootScope","$uibModalInstance","$http","xhrRequestOrigin","sjdDialog",function($scope,$rootScope,$uibModalInstance,$http,xhrRequestOrigin,sjdDialog){$scope.productName="",$scope.newProduct="",$scope.products=[],$scope.addNew=function(){var newID,ids=$scope.products.map(function(p){return p.erpid});do{var r1,r2;r1=Math.ceil(9*Math.random()),r2=Math.ceil(9*Math.random());var d=new Date;newID=d.getMonth()+1+""+d.getDate()+d.getHours()+d.getMinutes()+r1+r2}while(ids.indexOf(newID)>=0);$scope.products.push({erpid:newID,name:$scope.newProduct,selected:!0})},$scope.search=function(){var url=xhrRequestOrigin+"/stockproducts/customerproducts/list.do?enterpriseid="+$rootScope.enterpriseid;""!==$scope.productName&&(url=url+"&productname="+$scope.productName),$http.get(url).success(function(data){$scope.products=JSON.parse(data.value);for(var i=0;i<$scope.products.length;i++)$scope.products[i].selected=!1}).error(function(msg){sjdDialog.open("Error",msg)})},$scope.submit=function(){var result=$scope.products.filter(function(item){return item.selected}).map(function(n_item){return{erpid:n_item.erpid,name:n_item.name}});$uibModalInstance.close(result)},$scope.cancel=function(){$uibModalInstance.dismiss()}}]),mobileSJD.config(["$stateProvider","base",function($stateProvider,base){$stateProvider.state("goodsout",{url:"/goodsout",templateUrl:base+"/pages/goodsout/goodsout.html",controller:"goodsoutCtrl"})}]).controller("goodsoutCtrl",["$scope","$state","$uibModal","$http","xhrRequestOrigin","base","sjdDialog","Constants",function($scope,$state,$uibModal,$http,xhrRequestOrigin,base,sjdDialog,Constants){$scope.products=[],$scope.estimate=0,$scope.estimateTotal=Constants.estimateTotal,$scope.stockname="",$scope.contact="",$scope.phone="",$scope.receivingcompany="",$scope.receivingaddress="",$scope.memo="",$scope.addGoods=function(){$uibModal.open({templateUrl:base+"/pages/goodsout/add.html",controller:"goodsoutAddCtrl",windowClass:"sjd-page-goodsout-add-window",backdrop:"static",keyboard:!1}).result.then(function(data){for(var existingIDs=$scope.products.map(function(p){return p.erpid}),i=0;i<data.length;i++)existingIDs.indexOf(data[i].erpid)<0&&$scope.products.push({erpid:data[i].erpid,name:data[i].name,count:0,mortgaged:data[i].mortgaged,dealprice:data[i].dealprice,totalquantity:data[i].totalquantity})},function(){})},$scope.deleteProduct=function(index){$scope.products.splice(index,1)},$scope.getEstimate=function(){$scope.estimate=0,$scope.products.forEach(function(item){var c=isNaN(parseInt(item.count))?0:parseInt(item.count);$scope.estimate=$scope.estimate+parseFloat(item.dealprice)*c})},$scope.submit=function(){for(var hasMorgaged=0,requestData={header:{contact:$scope.contact,receivingcompany:$scope.receivingcompany,phone:$scope.phone,stockname:$scope.stockname,receivingaddress:$scope.receivingaddress,memo:$scope.memo,creator:"15267015541"},details:[]},i=0;i<$scope.products.length;i++)$scope.products[i].mortgaged&&(hasMorgaged=1),requestData.details.push({erpid:$scope.products[i].erpid,name:$scope.products[i].name,count:$scope.products[i].count,mortgaged:$scope.products[i].mortgaged?"是":"否",dealprice:$scope.products[i].dealprice});var url=xhrRequestOrigin+"/stockpost/sjd/deliveryPush.do?enterpriseid=240&hasMorgaged="+hasMorgaged;url=url+"&data="+JSON.stringify(requestData),$http.post(url).success(function(){$state.go("dashboard")}).error(function(msg){sjdDialog.open("Error",msg)})}}]).controller("goodsoutAddCtrl",["$scope","$rootScope","$uibModalInstance","$http","xhrRequestOrigin","sjdDialog",function($scope,$rootScope,$uibModalInstance,$http,xhrRequestOrigin,sjdDialog){$scope.productName="",$scope.products=[],$scope.search=function(){var url=xhrRequestOrigin+"/stockproducts/customerproducts/list.do?enterpriseid="+$rootScope.enterpriseid;""!==$scope.productName&&(url=url+"&productname="+$scope.productName),$http.get(url).success(function(data){$scope.products=JSON.parse(data.value);for(var i=0;i<$scope.products.length;i++)$scope.products[i].selected=!1}).error(function(msg){sjdDialog.open("Error",msg)})},$scope.submit=function(){var result=$scope.products.filter(function(item){return item.selected}).map(function(n_item){return{erpid:n_item.erpid,name:n_item.name,mortgaged:n_item.mortgaged,dealprice:n_item.dealprice,totalquantity:n_item.totalquantity}});$uibModalInstance.close(result)},$scope.cancel=function(){$uibModalInstance.dismiss()}}]),mobileSJD.config(["$stateProvider","base",function($stateProvider,base){$stateProvider.state("initial",{url:"/initial",templateUrl:base+"/pages/initial/initial.html",controller:"initialCtrl"})}]).controller("initialCtrl",["$scope","$rootScope","$state","$uibModal","$http","xhrRequestOrigin","base","sjdDialog",function($scope,$rootScope,$state,$uibModal,$http,xhrRequestOrigin,base,sjdDialog){void 0==$rootScope.enterpriseid&&$state.go("login"),1!=$rootScope.project.status&&$state.go("dashboard"),$scope.regaddr="",$scope.turnovers="",$scope.mainBusiness="",$scope.stockaddr="",$scope.avgstockvalue="";var clicked=!1;$http.get(xhrRequestOrigin+"/project/qulificationcheck/form.do?key=quiz&customerprojectid="+$rootScope.project.id).success(function(data){var quiz=JSON.parse(JSON.parse(data.content).quiz);$scope.regaddr=quiz.regaddr,$scope.turnovers=quiz.turnovers,$scope.mainBusiness=quiz.mainBusiness,$scope.stockaddr=quiz.stockaddr,$scope.avgstockvalue=quiz.avgstockvalue}).error(function(msg){sjdDialog.open("Error",msg)}),$scope.submit=function(){if(!clicked){clicked=!0;var url=xhrRequestOrigin+"/project/qulificationcheck/formsave.do?customerprojectid="+$rootScope.project.id,valueStr=JSON.stringify({turnovers:$scope.turnovers,regaddr:$scope.regaddr,mainBusiness:$scope.mainBusiness,stockaddr:$scope.stockaddr,avgstockvalue:$scope.avgstockvalue}),questionaire=JSON.stringify({key:"quiz",value:valueStr});url=url+"&questionaire="+questionaire,$http({method:"post",url:url,transformResponse:function(d){return d}}).success(function(){$http({method:"post",url:xhrRequestOrigin+"/project/completeAuthorization.do?customerprojectid="+$rootScope.project.id+"&enterpriseid="+$rootScope.enterpriseid,transformResponse:function(d){return d}}).success(function(){$state.go("dashboard")}).error(function(msg2){clicked=!1,sjdDialog.open("Error",msg2)})}).error(function(msg){clicked=!1,sjdDialog.open("Error",msg)})}},$scope.showDetail=function(){$uibModal.open({templateUrl:base+"/pages/initial/agreement.html",controller:"agreementCtrl",windowClass:"sjd-page-initial-agreement-window"})}}]).controller("agreementCtrl",["$scope",function($scope){}]),mobileSJD.config(["$stateProvider","base",function($stateProvider,base){$stateProvider.state("login",{url:"/login",templateUrl:base+"/pages/login/login.html",controller:"loginCtrl"})}]).controller("loginCtrl",["$scope","$state","$http","$rootScope","xhrRequestOrigin","sjdDialog",function($scope,$state,$http,$rootScope,xhrRequestOrigin,sjdDialog){$scope.login=function(){var url=xhrRequestOrigin+"/default/mobilelogin.do";$http({method:"POST",url:url,params:{username:$scope.username,password:$scope.password}}).success(function(data){null!=data&&($rootScope.user={},console.log(data),$rootScope.user=data,9==data.typeid&&($rootScope.enterpriseid=data.typeref),$state.go("dashboard"))}).error(function(msg){sjdDialog.open("Error",msg)})},$scope.toRegister=function(){$state.go("register")}}]),mobileSJD.config(["$stateProvider","base",function($stateProvider,base){$stateProvider.state("moneydetail",{url:"/moneydetail",templateUrl:base+"/pages/moneydetail/moneydetail.html",controller:"moneydetailCtrl"})}]).controller("moneydetailCtrl",["$scope","$rootScope","$http","$state","xhrRequestOrigin","base","$uibModal",function($scope,$rootScope,$http,$state,xhrRequestOrigin,base,$uibModal){function refresh(){$http.get(xhrRequestOrigin+"/api/loandetails/data.do?action=list_loan&loanid="+$rootScope.project.loanid).success(function(data){$scope.details=[];for(var i=0;i<data.value.length;i++){var obj={idloandetail:data.value[i].idloandetail,amount:parseFloat(parseFloat(data.value[i].amount).toFixed(2)),repaid:parseFloat(parseFloat(data.value[i].repaid).toFixed(2)),remain:parseFloat(parseFloat(data.value[i].amount).toFixed(2))-parseFloat(parseFloat(data.value[i].repaid).toFixed(2)),usedate:getDate(data.value[i].usedate),repaymentdate:getDate(data.value[i].repaymentdate),interest:parseFloat(data.value[i].interest),repaying:parseFloat(parseFloat(data.value[i].repaying).toFixed(2))};obj.current=parseFloat((obj.remain+obj.remain*obj.interest*(daysInterval(new Date(data.value[i].usedate.substring(0,10)),new Date)+1)/360).toFixed(2)),obj.expire=parseFloat((obj.remain+obj.remain*obj.interest*(daysInterval(new Date(data.value[i].usedate.substring(0,10)),new Date(data.value[i].repaymentdate.substring(0,10)))+1)/360).toFixed(2)),$scope.details.push(obj)}})}function getDate(str){var d=new Date(str.substring(0,10));return d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate()}function daysInterval(d1,d2){return parseInt((d2.getTime()-d1.getTime())/864e5)}$scope.details=[],refresh(),$scope.repay=function(detail){$uibModal.open({templateUrl:base+"/pages/moneydetail/repay.html",controller:"repayCtrl",windowClass:"sjd-page-moneydetail-repay-window",backdrop:"static",keyboard:!1,resolve:{detail:function(){return angular.copy(detail)}}}).result.then(function(){refresh()},function(){})},$scope.apply=function(){$state.go("moneyout")}}]).controller("repayCtrl",["$scope","$rootScope","$uibModalInstance","$http","detail","xhrRequestOrigin","sjdDialog",function($scope,$rootScope,$uibModalInstance,$http,detail,xhrRequestOrigin,sjdDialog){function formatDate(str){var list=str.split("-");return list[1]=1===list[1].length?"0"+list[1]:list[1],list[2]=1===list[2].length?"0"+list[2]:list[2],list.join("-")}function daysInterval(d1,d2){return parseInt((d2.getTime()-d1.getTime())/864e5)}$scope.detail=detail,$scope.date=new Date(formatDate($scope.detail.usedate)),$scope.opened=!1,$scope.repayAmount=0,$scope.estimate=0,$scope.dateOptions={formatYear:"yy",maxDate:new Date(formatDate($scope.detail.repaymentdate)),minDate:new Date(formatDate($scope.detail.usedate)),startingDay:1},$scope.toggleDatePicker=function(){$scope.opened=!$scope.opened},$scope.updateEstimate=function(){$scope.estimate=0,$scope.repayAmount>0&&$scope.date&&($scope.estimate=parseFloat(($scope.repayAmount+$scope.repayAmount*$scope.detail.interest*(daysInterval(new Date(formatDate($scope.detail.usedate)),$scope.date)+1)/360).toFixed(2)))},$scope.submit=function(){if($scope.repayAmount>0&&$scope.date){var fullDate=$scope.date.getFullYear()+"/"+($scope.date.getMonth()+1)+"/"+$scope.date.getDate();$http.post(xhrRequestOrigin+"/actionon/loan/repayapply.do?enterpriseid="+$rootScope.enterpriseid+"&loanid="+$rootScope.project.loanid+"&ref="+$scope.detail.idloandetail+"&repaying="+$scope.repayAmount+"&usedate="+fullDate,{},{transformResponse:function(v){return v}}).success(function(){$uibModalInstance.close()}).error(function(msg){sjdDialog.open("Error",msg)})}else sjdDialog.open("Info","请为还款金额以及还款时间输入有效值")},$scope.cancel=function(){$uibModalInstance.dismiss()}}]),mobileSJD.config(["$stateProvider","base",function($stateProvider,base){$stateProvider.state("moneyin",{url:"/moneyin",templateUrl:base+"/pages/moneyin/moneyin.html",controller:"moneyinCtrl"})}]).controller("moneyinCtrl",["$scope","$rootScope","$state","$http","xhrRequestOrigin","sjdDialog",function($scope,$rootScope,$state,$http,xhrRequestOrigin,sjdDialog){function getDate(str){var d=new Date(str.substring(0,10));return d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate()}function daysInterval(d1,d2){return parseInt((d2.getTime()-d1.getTime())/864e5)}function formatDate(str){var list=str.split("-");return list[1]=1===list[1].length?"0"+list[1]:list[1],list[2]=1===list[2].length?"0"+list[2]:list[2],list.join("-")}$scope.details=[],$scope.date=new Date,$scope.opened=!1,$scope.repayAmount=0,$scope.estimate=0,$scope.dateOptions={formatYear:"yy",maxDate:new Date("2020-05-27"),minDate:new Date,startingDay:1},$http.get(xhrRequestOrigin+"/api/loandetails/data.do?action=list_loan&loanid="+$rootScope.project.loanid).success(function(data){for(var i=0;i<data.value.length;i++){var obj={idloandetail:data.value[i].idloandetail,amount:parseFloat(parseFloat(data.value[i].amount).toFixed(2)),repaid:parseFloat(parseFloat(data.value[i].repaid).toFixed(2)),remain:parseFloat(parseFloat(data.value[i].amount).toFixed(2))-parseFloat(parseFloat(data.value[i].repaid).toFixed(2)),usedate:getDate(data.value[i].usedate),repaymentdate:getDate(data.value[i].repaymentdate),interest:parseFloat(data.value[i].interest),repaying:parseFloat(parseFloat(data.value[i].repaying).toFixed(2))};obj.current=parseFloat((obj.remain+obj.remain*obj.interest*(daysInterval(new Date(data.value[i].usedate.substring(0,10)),new Date)+1)/360).toFixed(2)),obj.expire=parseFloat((obj.remain+obj.remain*obj.interest*(daysInterval(new Date(data.value[i].usedate.substring(0,10)),new Date(data.value[i].repaymentdate.substring(0,10)))+1)/360).toFixed(2)),$scope.details.push(obj)}$scope.date=new Date(formatDate($scope.details[0].usedate)),$scope.dateOptions.minDate=new Date(formatDate($scope.details[0].usedate)),$scope.dateOptions.maxDate=new Date(formatDate($scope.details[0].repaymentdate)),$scope.current=angular.copy($scope.details[0])}),$scope.toggleDatePicker=function(){$scope.opened=!$scope.opened},$scope.selectDetail=function(detail){$scope.date=new Date(formatDate(detail.usedate)),$scope.dateOptions.minDate=new Date(formatDate(detail.usedate)),$scope.dateOptions.maxDate=new Date(formatDate(detail.repaymentdate)),$scope.current=angular.copy(detail)},$scope.updateEstimate=function(){$scope.estimate=0,$scope.repayAmount>0&&$scope.date&&($scope.estimate=parseFloat(($scope.repayAmount+$scope.repayAmount*$scope.current.interest*(daysInterval(new Date(formatDate($scope.current.usedate)),$scope.date)+1)/360).toFixed(2)))},$scope.submit=function(){if($scope.repayAmount>0&&$scope.date){var fullDate=$scope.date.getFullYear()+"/"+($scope.date.getMonth()+1)+"/"+$scope.date.getDate();$http.post(xhrRequestOrigin+"/actionon/loan/repayapply.do?enterpriseid="+$rootScope.enterpriseid+"&loanid="+$rootScope.project.loanid+"&ref="+$scope.current.idloandetail+"&repaying="+$scope.repayAmount+"&usedate="+fullDate,{},{transformResponse:function(v){return v}}).success(function(){$state.go("dashboard")}).error(function(msg){sjdDialog.open("Error",msg)})}else sjdDialog.open("Info","请为还款金额以及还款时间输入有效值")}}]),mobileSJD.config(["$stateProvider","base",function($stateProvider,base){$stateProvider.state("moneyout",{url:"/moneyout",templateUrl:base+"/pages/moneyout/moneyout.html",controller:"moneyoutCtrl"})}]).controller("moneyoutCtrl",["$scope","$rootScope","$state","$http","xhrRequestOrigin","sjdDialog",function($scope,$rootScope,$state,$http,xhrRequestOrigin,sjdDialog){$http.get(xhrRequestOrigin+"/api//loanstatement/data.do?action=loan&loanid="+$rootScope.project.loanid).success(function(data){$scope.usedamount=parseFloat(data.value.usedamount.toFixed(2)),$scope.ratio=data.value.ratio,$scope.interest=data.value.interest,$scope.amount=parseFloat(data.value.amount.toFixed(2)),$scope.remain=$scope.amount-$scope.usedamount;var d=new Date(data.value.expireddate);$scope.expireddate=d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate()}),$scope.applyAmount=0,$scope.remark="",$scope.durations=[{value:"3个月",name:"3个月"},{value:"6个月",name:"6个月"},{value:"12个月",name:"12个月"}],$scope.selectedDuration=$scope.durations[0].value,$scope.submit=function(){if($scope.applyAmount>0){var url=xhrRequestOrigin+"/actionafter/applyuse/loandetails.do?customerprojectid="+$rootScope.project.id+"&amount="+$scope.applyAmount+"&reriodtime="+$scope.selectedDuration;""!==$scope.remark&&(url=url+"&remark="+$scope.remark),$http.post(url,{},{transformResponse:function(v){return v}}).success(function(){$state.go("dashboard")}).error(function(msg){sjdDialog.open("Error",msg)})}else sjdDialog.open("Info","使用额度必须大于0")}}]),mobileSJD.config(["$stateProvider","base",function($stateProvider,base){$stateProvider.state("register",{url:"/register",templateUrl:base+"/pages/register/register.html",controller:"registerCtrl"})}]).controller("registerCtrl",["$scope","$rootScope","$interval","$state","$http","xhrRequestOrigin","sjdDialog",function($scope,$rootScope,$interval,$state,$http,xhrRequestOrigin,sjdDialog){var isMobile=function(mobile){return void 0==mobile?!1:angular.isNumber(mobile)?11!=(mobile+"").length?!1:!!/^(13[0-9]|14[0-9]|15[0-9]|18[0-9])\d{8}$/i.test(mobile+""):!1};$scope.mobilevalid_check=function(){isMobile($scope.mobile)?$scope.code_send=!0:$scope.code_send=!1},$scope.sendMobileCode=function(){var mobilecode_url=xhrRequestOrigin+"/default/mobileverify.do?";$http.get(mobilecode_url+"mobile="+$scope.mobile).success(function(response){
$scope.code=response,$scope.code_send=!1;var count=10;$interval(function(){count--,$scope.count_down="("+count+")",0==count&&($scope.code_send=!0,$scope.count_down="")},1e3,count)}).error(function(response,status){console.log(response)})},$scope.register=function(){var registerUrl=xhrRequestOrigin+"/default/mobileregister.do?from=HDD&",formData={};formData.title=$scope.name+$scope.title,formData.mobile=$scope.mobile,formData.password=$scope.pwd,formData.code=$scope.mobile_checknum,$http({method:"POST",url:registerUrl,params:formData}).success(function(response){var url=xhrRequestOrigin+"/default/mobilelogin.do";$http({method:"POST",url:url,params:{username:$scope.mobile,password:$scope.pwd}}).success(function(data){null!=data&&($rootScope.user={},console.log(data),$rootScope.user=data,9==data.typeid&&($rootScope.enterpriseid=data.typeref),$state.go("dashboard"))}).error(function(msg){sjdDialog.open("Error",msg)})}).error(function(response,status){sjdDialog.open("Error",response)})}}]),mobileSJD.config(["$stateProvider","base",function($stateProvider,base){$stateProvider.state("welcome",{url:"/welcome",templateUrl:base+"/pages/welcome/welcome.html",controller:"welcomeCtrl"})}]).controller("welcomeCtrl",["$scope","$state",function($scope,$state){$scope.next=function(){$state.go("login")}}]),mobileSJD.service("sjdDialog",["$uibModal","base",function($uibModal,base){this.open=function(type,msg){var instance=$uibModal.open({templateUrl:base+"/services/sjdDialog/sjdDialog"+type+".html",controller:["$scope","$uibModalInstance","message",function($scope,$uibModalInstance,message){$scope.message=message,$scope.close=function(){$uibModalInstance.close()}}],windowClass:"sjd-dialog-window",backdrop:"static",keyboard:!1,resolve:{message:function(){return msg}}});return instance.result}}]),mobileSJD.directive("sjdTopNavBar",["base",function(base){return{restrict:"E",scope:{prevState:"@",prevText:"@",nextState:"@",nextText:"@",navTitle:"@"},link:function(scope,element,attrs){},controller:["$scope","$state",function($scope,$state){$scope.next=function(){$state.go($scope.nextState)},$scope.prev=function(){$state.go($scope.prevState)}}],templateUrl:base+"/widgets/sjdTopNavBar/sjdTopNavBar.html"}}]);